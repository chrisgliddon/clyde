;------------------

	SECTION	SND_DRIVER,?


AUDRAM	EQU	$1000

SOUND_700DRIVER
	INCBIN	S700AUD.ROM


;------------------

	SET_AXY16
	LDA	#AUDRAM
SOUND_SNESDRIVER
	INCBIN	SNESAUD.ROM

;------------------
;INIT THE AUDIO CHIP


TEST_SND	MODULE

	PHP
	SET_AXY16
;-----
	LDX	#<SOUND_700DRIVER
	LDA	#^SOUND_700DRIVER
	LDY	#0
	AUDCALL	audcold	;COLDSTART AUDIO

	LDA	#0
	STA	AUDRAM+2	;NOTHING YET
	LDX	#-2	;START OF AVAILABLE MEMORY
	LDY	#<SONG1_SAMPLES	;SAMPLES
	LDA	#^SONG1_SAMPLES
	AND	#$00FF	;MASK HIGH BYTE TO ZERO
	AUDCALL	send_sample_package


	LDA	#0
	STA	AUDRAM+2	;NOTHING YET
	LDX	#-1	;NEXT AVAILABLE MEMORY
	LDY	#<SONG1_INST	;INSURMENT DATA
	LDA	#^SONG1_INST
	AUDCALL	send_instrument_package


	LDA	#1
	STA	AUDRAM+2	;NOTHING YET
	LDX	#-1	;NEXT AVAILABLE MEMORY
	LDY	#<SONG1_MIDI	;MIDI DATA
	LDA	#^SONG1_MIDI
	AUDCALL	send_music_package


	LDA	#1	;FLUSH DOWNLOADS RIGHT NOW
	AUDCALL	audio_frame


	LDA	#$0000
	LDX	#$8000
	LDY	#$7FFF
	AUDCALL	do_music

	LDA	#0
	AUDCALL	flush_command_queue

	PLP
	RTL


	MODEND

;------------------
;NEW_SONG -- PLAY THE NEXT SONG IN THE TABLE

;-----

SONG_SAMPLES	DL	SONG1_SAMPLES
	DL	SONG4_SAMPLES
	DL	SONG2_SAMPLES
	DL	SONG3_SAMPLES
	DW	0

SONG_INST	DL	SONG1_INST
	DL	SONG4_INST
	DL	SONG2_INST
	DL	SONG3_INST

SONG_MIDI	DL	SONG1_MIDI
	DL	SONG4_MIDI
	DL	SONG2_MIDI
	DL	SONG3_MIDI

;-----

NEW_SONG	MODULE

	PHP
	SET_AXY16
;-----
	LDX	#BMCT_KILLID	;STOP ALL SONGS
	LDY	#$00FF
	AUDCALL	do_sound_controller
@FLUSH_AGAIN	LDA	#0	;STOP IT NOW
	AUDCALL	flush_command_queue
;	BCS	@FLUSH_AGAIN

	LDX	#0
@WAIT_LP	JSL	WAIT_CALL
	DEX
	CPX	#0
	BNE	@WAIT_LP

	AUDCALL	audinit
;-----
	SET_A8
	LDA	#^SONG_SAMPLES
	PHA
	PLB
	SET_A16
;-----
	INC	SONG_PTR	;NEXT SONG
@SONG_LP	LDA	SONG_PTR
	ASL	A
	ASL	A	;# *4
	TAX
	LDA	SONG_SAMPLES,X	;SEE IF END OF SONG LIST
	CMP	#0
	BNE	@SONG_OK
	STZ	SONG_PTR
	JMP	@SONG_LP
@SONG_OK	PHX
	
	LDA	#0
	STA	AUDRAM+2	;NOTHING YET
	LDY	SONG_SAMPLES,X	;SAMPLES
	LDA	SONG_SAMPLES+2,X
	AND	#$00FF	;MASK HIGH BYTE TO ZERO
	LDX	#-2	;START OF AVAILABLE MEMORY
	AUDCALL	send_sample_package

	PLX
	PHX

	LDA	#0
	STA	AUDRAM+2	;NOTHING YET
	LDY	SONG_INST,X	;INSURMENT DATA
	LDA	SONG_INST+2,X
	LDX	#-1	;NEXT AVAILABLE MEMORY
	AUDCALL	send_instrument_package

	PLX

	LDA	#1
	STA	AUDRAM+2	;NOTHING YET
	LDY	SONG_MIDI,X	;MIDI DATA
	LDA	SONG_MIDI+2,X
	LDX	#-1	;NEXT AVAILABLE MEMORY
	AUDCALL	send_music_package


	LDA	#1	;FLUSH DOWNLOADS RIGHT NOW
	AUDCALL	audio_frame


	LDA	#$0000
	LDX	#$8000
	LDY	#$7FFF
	AUDCALL	do_music

	LDA	#0
	AUDCALL	flush_command_queue

	PLP
WAIT_CALL	RTL


	MODEND

;------------------


